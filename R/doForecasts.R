

#' Forecast Human Mortality
#' 
#' @param object An object of the class \code{MotalityModels} generated by the
#' \code{\link{doMortalityModels}} function.
#' @param ... Further argumets to be passed to other methods.
#' @inheritParams CoDa::predict.coda
#' @examples 
#' x = 0:100
#' y = 1985:1999
#' h = 17
#' dxm <- dxForecast::dxForecast.data$dx$male[paste(x), paste(y)]
#' ex <- dxForecast::dxForecast.data$ex$male
#' exogen <- ex[paste(y)]
#' 
#' MM = c("LC", "FDM", "CoDa", "M6", "M6X")
#' M <- doMortalityModels(data = dxm, x, y, data.type = "dx",
#'                        models = MM, exogen = exogen)
#'                        
#' P <- doForecasts(M, h, ci = 95, jumpchoice = "actual")
#' 
#' pex <- getForecasts(P, what = "ex")
#' @export
doForecasts <- function(object, h, ci = 95, 
                        jumpchoice = c("actual", "fit"), ...) {
  input <- as.list(environment())
  call  <- match.call()
  x     <- object$x
  y     <- max(object$y) + 1:h
  Mn    <- object$input$models # Model names
  jumpchoice  <- match.arg(jumpchoice)
  
  
  for (i in 1:length(Mn)) {
    cat(Mn[i], "\n")
    M <- with(object, get(Mn[i]))
    
    if (Mn[i] %in% c("LC", "PLAT", "FDM")) {
      P <- forecast(M, h = h, jumpchoice = jumpchoice, level = ci)
    } else {
      P <- predict(M, h = h, jumpchoice = jumpchoice, ci = ci)
    }
    assign(Mn[i], P)
  }
  
  remove(object, h, ci, jumpchoice, M, Mn, P, i)
  out <- as.list(environment())
  out <- structure(class = "doForecasts", out)
  return(out)
}


#' Get Predicted Values
#' 
#' @param object An object of the class \code{doForecasts}.
#' @inheritParams getFitted
#' @export
#' 
getForecasts <- function(object, 
                         what = c("qx", "mx", "dx", "lx", "Lx", "Tx", "ex"),
                         ...) {
  what <- match.arg(what)
  Mn   <- object$input$object$input$models # Model names
  x    <- object$x
  
  DX <- list()
  for (i in 1:length(Mn)) {
    M <- with(object, get(Mn[i]))
    
    if (Mn[i] %in% c("LC", "PLAT")) {
      mx <- M$rates
      dx <- convertFx(x, mx, In = "mx", Out = "dx", lx0 = 1, ...)
      
    } else if (Mn[i] %in% c("FDM")) {
      mx <- M$rate$mean
      dx <- convertFx(x, mx, In = "mx", Out = "dx", lx0 = 1, ...)
      
    } else {
      dx <- M$predicted.values
    }
    DX[[i]] <- dx
  }
  
  fn  <- function(Z) convertFx(x, Z, In = "dx", Out = what, lx0 = 1)
  out <- lapply(DX, fn)
  names(out) <- Mn
  out <- structure(class = "getForecasts", out)
  return(out)
}
