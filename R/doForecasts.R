

#' Forecast Human Mortality
#' 
#' @param object An object of the class \code{MotalityModels} generated by the
#' \code{\link{doMortalityModels}} function.
#' @param ... Further argumets to be passed to other methods.
#' @inheritParams CoDa::predict.coda
#' @export
doForecasts <- function(object, h, ci = 95, 
                        jumpchoice = c("actual", "fit"), ...) {
  input <- as.list(environment())
  call  <- match.call()
  x     <- object$x
  y     <- max(object$y) + 1:h
  jumpchoice  <- match.arg(jumpchoice)
  model.names <- object$model.names
  
  # M1 <- forecast(object$M1, h = h, level = ci)
  M2 <- forecast(object$M2, h = h, jumpchoice = jumpchoice, level = ci)
  for (i in 3:9) {
    Mi <- with(object, get(paste0("M", i)))
    assign(paste0("M", i), predict(Mi, h = h, jumpchoice = jumpchoice, ci = ci))
    cat(i, "\n")
  }
  
  remove(object, h, ci, jumpchoice, Mi, i)
  out <- as.list(environment())
  out <- structure(class = "doForecasts", out)
  return(out)
}

#' Get Predicted Values
#' 
#' @param object An object of the class \code{doForecasts}.
#' @inheritParams getFitted
#' @export
#' 
getForecasts <- function(object, 
                      type = c("qx", "mx", "dx", "lx", "Lx", "Tx", "ex"),
                      ...) {
  type <- match.arg(type)
  x    <- object$x
  
  # mx1 <- object$M1$mean
  # dx1 <- convertFx(x, mx1, In = "mx", Out = "dx", lx0 = 1)
  mx2 <- object$M2$rates
  dx2 <- convertFx(x, mx2, In = "mx", Out = "dx", lx0 = 1)
  
  dx3 = dx4 = dx5 = dx6 = dx7 = dx8 = dx9 <- NULL
  for (i in 3:9) {
    Mi <- with(object, get(paste0("M", i)))
    assign(paste0("dx", i), Mi$predicted.values)
  }
  
  dx  <- list(dx2, dx3, dx4, dx5, dx6, dx7, dx8, dx9)
  fn  <- function(Z) convertFx(x, Z, In = "dx", Out = type, lx0 = 1)
  out <- lapply(dx, fn)
  names(out) <- object$model.names
  out <- structure(class = "getForecasts", out)
  return(out)
}
